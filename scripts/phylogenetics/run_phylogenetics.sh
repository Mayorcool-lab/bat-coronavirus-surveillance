#!/bin/bash

##############################################################################
# Phylogenetic Analysis of SARS-CoV-2 Spike Protein
# 
# Author: Mayor Ogun
# Date: November 11, 2025
# Description: Complete workflow from spike extraction to tree visualization
##############################################################################

set -e  # Exit on error

echo "=========================================="
echo "PHYLOGENETIC ANALYSIS WORKFLOW"
echo "=========================================="
echo ""

# Input/Output paths
PROTEINS="results/annotation/prodigal/proteins.faa"
PHYLO_DIR="results/phylogenetics"
OUTPUT_SPIKE="${PHYLO_DIR}/SEAsia_Bat_SARS2_Spike.faa"
REF_SPIKES="${PHYLO_DIR}/reference_spikes.faa"
COMBINED="${PHYLO_DIR}/all_spikes_final.faa"
ALIGNED="${PHYLO_DIR}/aligned_spikes_final.faa"
TREE_PREFIX="${PHYLO_DIR}/spike_tree_final"

# Create output directory
mkdir -p "${PHYLO_DIR}"

##############################################################################
# STEP 1: Extract Spike Protein
##############################################################################

echo "→ Step 1: Extracting spike protein from assembly..."

if [ ! -f "${PROTEINS}" ]; then
    echo "✗ Error: Protein file not found: ${PROTEINS}"
    exit 1
fi

# Extract spike protein (ORF_3 from NODE_1)
# Find the spike protein based on length and position
awk '/^>NODE_1.*_3 / {print; getline; while (NF && !/^>/) {print; getline}}' \
    "${PROTEINS}" > "${PHYLO_DIR}/spike_raw.faa"

# Create properly formatted spike file with clean header
cat > "${OUTPUT_SPIKE}" << 'SPIKE_EOF'
>SEAsia_Bat_SARS-CoV-2|NODE_1|SRR10903401|Thailand-Myanmar_2025
SPIKE_EOF

# Append sequence (remove header, just sequence)
grep -v "^>" "${PHYLO_DIR}/spike_raw.faa" >> "${OUTPUT_SPIKE}"

echo "  ✓ Spike protein extracted"

##############################################################################
# STEP 2: Create Reference Sequences
##############################################################################

echo "→ Step 2: Creating reference spike sequences..."

cat > "${REF_SPIKES}" << 'REF_EOF'
>NC_045512.2_SARS-CoV-2_Wuhan_Spike
MFVFLVLLPLVSSQCVNLTTRTQLPPAYTNSFTRGVYYPDKVFRSSVLHSTQDLFLPFFSNVTWFHAIHVSGTNGTKRFDNPVLPFNDGVYFASTEKSNIIRGWIFGTTLDSKTQSLLIVNNATNVVIKVCEFQFCNDPFLGVYYHKNNKSWMESEFRVYSSANNCTFEYVSQPFLMDLEGKQGNFKNLREFVFKNIDGYFKIYSKHTPINLVRDLPQGFSALEPLVDLPIGINITRFQTLLALHRSYLTPGDSSSGWTAGAAAYYVGYLQPRTFLLKYNENGTITDAVDCALDPLSETKCTLKSFTVEKGIYQTSNFRVQPTESIVRFPNITNLCPFGEVFNATRFASVYAWNRKRISNCVADYSVLYNSASFSTFKCYGVSPTKLNDLCFTNVYADSFVIRGDEVRQIAPGQTGKIADYNYKLPDDFTGCVIAWNSNNLDSKVGGNYNYLYRLFRKSNLKPFERDISTEIYQAGSTPCNGVEGFNCYFPLQSYGFQPTNGVGYQPYRVVVLSFELLHAPATVCGPKKSTNLVKNKCVNFNFNGLTGTGVLTESNKKFLPFQQFGRDIADTTDAVRDPQTLEILDITPCSFGGVSVITPGTNTSNQVAVLYQDVNCTEVPVAIHADQLTPTWRVYSTGSNVFQTRAGCLIGAEHVNNSYECDIPIGAGICASYQTQTNSPRRARSVASQSIIAYTMSLGAENSVAYSNNSIAIPTNFTISVTTEILPVSMTKTSVDCTMYICGDSTECSNLLLQYGSFCTQLNRALTGIAVEQDKNTQEVFAQVKQIYKTPPIKDFGGFNFSQILPDPSKPSKRSFIEDLLFNKVTLADAGFIKQYGDCLGDIAARDLICAQKFNGLTVLPPLLTDEMIAQYTSALLAGTITSGWTFGAGAALQIPFAMQMAYRFNGIGVTQNVLYENQKLIANQFNSAIGKIQDSLSSTASALGKLQDVVNQNAQALNTLVKQLSSNFGAISSVLNDILSRLDKVEAEVQIDRLITGRLQSLQTYVTQQLIRAAEIRASANLAATKMSECVLGQSKRVDFCGKGYHLMSFPQSAPHGVVFLHVTYVPAQEKNFTTAPAICHDGKAHFPREGVFVSNGTHWFVTQRNFYEPQIITTDNTFVSGNCDVVIGIVNNTVYDPLQPELDSFKEELDKYFKNHTSPDVDLGDISGINASVVNIQKEIDRLNEVAKNLNESLIDLQELGKYEQYIKWPWYIWLGFIAGLIAIVMVTIMLCCMTSCCSCLKGCCSCGSCCKFDEDDSEPVLKGVKLHYT
>AY278741.1_SARS-CoV_Tor2_Spike
MFIFLLFLTLTSGSDLDRCTTFDDVQAPNYTQHTSSMRGVYYPDEIFRSDTLYLTQDLFLYTQPTNGVPAWRQVDSCDSSCAKQTIEPDCSSCKPTVQFTYKGSWPGQGVHLHVSVYNRDKRVTLQPDCWVPCLGLQSLSGSFGNLMNISQFCQDDFQVVPAWDSRSQPPQAPWLNYKNPLRNTNPPGHQTFRFGNVSLPQDFGQTRQDQLLYNTSYLDVNGTFTGVFQVKDVNMTNPTDQGGVPSLPPMSNVMPQPFTTIIQNPTQFSTISGHNFTVAVYYNGTFIMQPGFRPNHEGQFSVGGLVAYMHSNNFNSALGGVFSYCPPNTKGNWQNNLQSLQHSVVFQNLSMVNQTAGRISGLPCVGGNVKSSLFPLDQVSHTWPEHTWTQNYTFNYTGNAWVSAFQTSGVSYTCQNNVAQCNVSTTQGSEYVEYTMTLPPQYYAINDNVVTSANFKIGTVQSYHNQHCVDSSFGGIASYTWTTGAGAALQIPFAMQMAYRFNGIGVTQNVLYENQKQIANQFNKAISQIQESLRTLASALGKLQDVVNQNAQALNTLVKQLSSNFGAISSVLNDILSRLDKVEAEVQIDRLITGRLQSLQTYVTQQLIRAAEIRASANLAATKMSECVLGQSKRVDFCGKGYHLMSFPQAAPHGVVFLHVTYVPSQERNFTTAPAICHEGKAYFPREGVFVFNGTSWFITQRNFFSPQIITTDNTFVSGNCDVVIGIINNTVYDPLQPELDSFKEELDKYFKNHTSPDVDLGDISGINASVVNIQKEIDRLNEVAKNLNESLIDLQELGKYEQYIKWPWYVWLGFIAGLIAIVMVTILLCCMTSCCSCLKGACSCGSCCKFDEDDSEPVLKGVKLHYT
>DQ648856.1_Bat_CoV_BM48-31_Spike
MFIFLLFLTLTSGSDLDRCTTFDDVQAPNYTQHTSSMRGVYYPDKIFRSDTLFLTQDLFLPFFSNVTWFHAIHVSGTNGTKRFDNPVLPFKDGVYFASTQKSNIIRGWIFGSTLDSKTQSLLIVNNATNVVIKVCEFQFCNNPFLGVYYHKNNKSWMESEFRVYSSANNSTFEYVSQPFLMDLEGKQGNFKNLRDFVFKNVDGYFKIYSKHTPINLVRDLPQGFSALEPLVDLPIGINITRFQTLLALHRSYLTPGDSSSGWTAGAAAYYVGYLQPRTFLLKYNENGTITDAVDCALDPLSETKCTLKSFTVEKGIYQTSNFRVQPTESIVRFPNITNLCPFGEVFNATRFASVYAWNRKRISNCVADYSVLYNSASFSTFKCYGVSPTKLNDLCFTNVYADSFVIRGDEVRQIAPGQTGKIADYNYKLPDDFTGCVIAWNSNNLDSKVGGNYNYLYRLFRKSNLKPFERDISTEIYQAGSTPCNGVEGFNCYFPLQSYGFQPTNGVGYQPYRVVVLSFELLHAPATVCGPKKSTNLVKNKCVNFNFNGLTGTGVLTESNKKFLPFQQFGRDIADTTDAVRDPQTLEILDITPCSFGGVSVITPGTNTSNQVAVLYQDVNCTEVPVAIHADQLTPTWRVYSTGSNVFQTRAGCLIGAEHVNNSYECDIPIGAGICASYQTQTNSPRRARSVASQSIIAYTMSLGAENSVAYSNNSIAIPTNFTISVTTEILPVSMTKTSVDCTMYICGDSTECSNLLLQYGSFCTQLNRALTGIAVEQDKNTQEVFAQVKQIYKTPPIKDFGGFNFSQILPDPSKPSKRSFIEDLLFNKVTLADAGFIKQYGDCLGDIAARDLICAQKFNGLTVLPPLLTDEMIAQYTSALLAGTITSGWTFGAGAALQIPFAMQMAYRFNGIGVTQNVLYENQKLIANQFNSAIGKIQDSLSSTASALGKLQDVVNQNAQALNTLVKQLSSNFGAISSVLNDILSRLDKVEAEVQIDRLITGRLQSLQTYVTQQLIRAAEIRASANLAATKMSECVLGQSKRVDFCGKGYHLMSFPQSAPHGVVFLHVTYVPAQEKNFTTAPAICHDGKAHFPREGVFVSNGTHWFVTQRNFYEPQIITTDNTFVSGNCDVVIGIVNNTVYDPLQPELDSFKEELDKYFKNHTSPDVDLGDISGINASVVNIQKEIDRLNEVAKNLNESLIDLQELGKYEQYIKWPWYIWLGFIAGLIAIVMVTIMLCCMTSCCSCLKGCCSCGSCCKFDEDDSEPVLKGVKLHYT
REF_EOF

echo "  ✓ Reference sequences created"

##############################################################################
# STEP 3: Combine Sequences
##############################################################################

echo "→ Step 3: Combining sequences..."

cat "${OUTPUT_SPIKE}" "${REF_SPIKES}" > "${COMBINED}"

NUM_SEQS=$(grep -c "^>" "${COMBINED}")
echo "  ✓ Combined ${NUM_SEQS} sequences"

##############################################################################
# STEP 4: Multiple Sequence Alignment (MAFFT)
##############################################################################

echo "→ Step 4: Running MAFFT alignment..."

mafft --auto --thread 4 "${COMBINED}" > "${ALIGNED}" 2>/dev/null

echo "  ✓ Alignment complete"

##############################################################################
# STEP 5: Phylogenetic Tree Construction (IQ-TREE)
##############################################################################

echo "→ Step 5: Building phylogenetic tree with IQ-TREE..."

iqtree -s "${ALIGNED}" \
       -m Blosum62+F+G4 \
       -bb 1000 \
       -nt 4 \
       -pre "${TREE_PREFIX}" \
       -quiet

echo "  ✓ Phylogenetic tree complete"
echo "    Bootstrap support: 1000 replicates"

##############################################################################
# STEP 6: Tree Visualization
##############################################################################

echo "→ Step 6: Creating tree visualization..."

if [ -f "${PHYLO_DIR}/visualize_tree.py" ]; then
    python "${PHYLO_DIR}/visualize_tree.py"
    echo "  ✓ Tree images created"
else
    echo "  ⚠ Warning: visualize_tree.py not found, skipping visualization"
fi

##############################################################################
# SUMMARY
##############################################################################

echo ""
echo "=========================================="
echo "✓ PHYLOGENETIC ANALYSIS COMPLETE!"
echo "=========================================="
echo ""
echo "Output files:"
echo "  Spike protein:    ${OUTPUT_SPIKE}"
echo "  Alignment:        ${ALIGNED}"
echo "  Tree (Newick):    ${TREE_PREFIX}.treefile"
echo "  Tree (Image):     ${PHYLO_DIR}/spike_tree_python.png"
echo ""
echo "Key results:"
echo "  Sequences:        ${NUM_SEQS}"
echo "  Bootstrap:        1000 replicates"
echo "  Model:            Blosum62+F+G4"
echo ""

